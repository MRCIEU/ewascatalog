# EWAS Catalog and Docker

This folder contains files needed to 'dockerize' the website:
`docker-compose.yml`, `Dockerfile`, `python-requirements.txt`.
These files are copied to the website base directory by the
project [catalog](../catalog) script before building the docker containers.

The remainder of this document gives information
for working with docker.

## If docker is not installed (on an Ubuntu machine) ...

Remove anything out-of-date:
```
sudo apt-get remove docker docker-engine docker.io
```

Install docker:
```
sudo apt install docker.io
sudo apt install docker-compose
```

Setup docker to run automatically at startup:
```
sudo systemctl start docker
sudo systemctl enable docker
```

## Docker group needed to run docker commands

For a user to run docker commands,
they will need to belong to the docker
linux permissions group.
```
sudo usermod -a -G docker [USER]
```
You will need to log out and then back
in again for this to take effect.

## Defining the docker container environment

Docker itself only looks at a `Dockerfile` to create the environment.
However, we are using `docker-compose` which provides
a more convenient layer on top of docker
for defining multiple cooperating containers,
hence `docker-compose.yml`.

### `docker-compose.yml`

This file defines the services, networks and volumes
of the container.

Below, we define three services, 'web', 'db' and 'nginx'. 

```
web:                                 ## name of service to reference in docker-compose commands
  restart: always                    ## restart the service if at all possible
  build:
    context: .                       ## host directory containing Dockerfile
    args:
      - USER_ID=${USER_ID}           ## user/group id arguments 
      - GROUP_ID=${GROUP_ID}         ##  assigned on command line
	                                 ##  (see '../catalog' script)
  user: ${USER_ID}:${GROUP_ID}       ## run as defined user 
  container_name: dev.ewascatalog    ## name of container to reference in docker commands
  volumes:                          
    - .:/code                        ## volume at /code/ in container linking to host directory '.' 
    - ${FILES_DIR}:/files            ## volume at /files/ in container linking to ${FILES_DIR} on host
  links:
    - db:db                          ## allows 'web' to access 'db' service using 'db' 
  command: gunicorn website.wsgi:application --timeout 600 -w 2 -b :8000
                                     ## use gunicorn communicate between the website and our python code
				     ## note: 'application' object is created in our website/wsgi.py
				   
db:                                  ## name of service to reference in docker-compose commands 
  env_file:
    - ./settings.env                 ## variables defining the database environment/access
  ports:
    - '3306'                         ## mysql server port
  image: mysql:5.7                   ## specify the docker image of the mysql server
  container_name: dev.ewascatalog_db ## name of container to reference in docker commands
  volumes:                           ## see above
    - .:/code
    - ${FILES_DIR}:/files

nginx:                               ## name of webserver service (we use NGINX)
  restart: always                    ## restart service if at all possible
  build: ./webserver/                ## host directory containing the Dockerfile
  container_name: dev.ewascatalog_srv
  volumes:                           ## see above
    - .:/code                        
  volumes_from:
    - web                   
  links:                          
    - web:web                        ## allows web server to access the website code as 'web'
  ports: 
    - "8080:80"                      ## website requests to the host machine at port 8080
                                     ##  will be forwarded to port 80 of this container
                				     ##  where the nginx web server will be listening
```


### Dockerfile for python and R requirements

Commands for preparing the docker container.
See commented [Dockerfile](Dockerfile).

## Debugging docker

Errors generated by a docker container can be viewed using
the `docker logs` command on the command-line.
The following example shows the last 50 lines of the error log
for the website docker container.
```
docker logs --tail 50 --follow --timestamps dev.ewascatalog
```
